<!doctype html>
<html lang="en">


<head>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-widthinitial-scale=1">
    <title>undefined</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/roboto@4.5.1/latin-300.css"
        integrity="sha256-69VEtqsA54dXolmlOOpB6AUTkUBjI8SjBKCQ7ycib6I=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/roboto@4.5.1/latin-700.css"
        integrity="sha256-tB5d+zyWiHQFQmJbLkUB/R3yq3K5zmN+38cBOZBwjkg=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/roboto-mono@4.5.0/latin-300.css"
        integrity="sha256-/bTf0ZdBXp9eQn0Xbgim3IoygJpVg108KstIe5AKO7E=" crossorigin="anonymous">
</head>

<body>

    <section class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <h1>haeley-<strong>math</strong></h1>
                <p class="lead">Test Page for Development</p>
                <p>// about:
                    version <code id="version">version</code>,
                    branch <code id="branch">branch</code>,
                    commit <code id="commit">commit</code>.
                </p>

            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <h2>Camera Test:</h2>
                <p>Compare virtual camera math (gl-matrix) with math based on <a
                        href="https://cgmath.cc/units/virtual-camera.html">cgmath.cc</a>.</p>

                <p class="mb-1">camera <code>eye</code>, <code>center</code>, and <code>up</code> as well as
                    <code>near</code>, <code>far</code>, <code>fovy</code>, and <code>aspect</code>:
                </p>
                <pre class="bg-light px-3 py-2 border-start" id="camera"></pre>

                <p class="mb-1">camera.view (gl-matrix mat4.lookAt) left vs. cgmath lookAt (transposed) right:</p>
                <pre class="bg-light px-3 py-2 border-start" id="camera.view"></pre>

                <p class="mb-1">camera.projection (gl-matrix mat4.perspective) left vs. cgmath projection (transposed)
                    right:</p>
                <pre class="bg-light px-3 py-2 border-start" id="camera.projection"></pre>

                <p class="mb-1">cgmath projection sub-transforms (PI, PII, PIII):</p>
                <pre class="bg-light px-3 py-2 border-start" id="camera.p123"></pre>

            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <h2>Matrix Log Tests</h2>
                <p>Check out the actual console output for the interleaved sequence of log messages.</p>

                <p><strong>Console Log</strong> Capture:</p>
                <pre class="bg-light px-3 py-2 border-start text-black" id="log"></pre>

            </div>
        </div>

    </section>

    <footer>
        <div class="row text-center">
            <div class="col-12">
                <p class="mt-5 mb-4">
                    &copy; 2016&thinsp;&ndash;&thinsp;<span id="cryear"></span>
                </p>
            </div>
        </div>
    </footer>

</body>

<script type="module">
    import * as auxiliaries from 'haeley-auxiliaries';
    import * as math from './index.ts';
    window['haeley'] = { auxiliaries, math };
</script>

<script>

    const log = document.querySelector('#log');
    var genuineLog = console.log;
    console.log = function () {
        genuineLog.apply(console, arguments);
        log.innerHTML += [...arguments].join(' ') + '\n';
    };

    window.onload = () => {

        document.title = __LIB_NAME__;
        document.querySelector('#version').innerHTML = haeley.math.version();
        document.querySelector('#branch').innerHTML = haeley.math.branch();
        document.querySelector('#commit').innerHTML = haeley.math.commit();
        document.querySelector('#cryear').innerHTML = new Date().getFullYear();

        console.log("'haeley-math' imported:", haeley);

        const math = haeley.math;

        {   // virtual camera math test

            const vec3 = math.vec3;
            const vec4 = math.vec4;
            const mat4 = math.mat4;

            const camera = new math.Camera();
            camera.eye = [0.0, 0.0, 0.0]; // [2.0, 0.5, -4.0];
            camera.center = [0.0, 0.0, 1.0]; // [0.0, -0.5, 2.0];
            camera.up = [0.0, 1.0, 0.0]; //[0.0, 2.0, 0.0];
            camera.near = 0.5;
            camera.far = 1.0;
            camera.aspect = 16.0 / 9.0;

            window['camera'] = camera;

            const preCamera = document.getElementById('camera');
            preCamera.innerHTML = math.interleaveMatrixStrings([
                vec3.toMatrixString(camera.eye, 2),
                vec3.toMatrixString(camera.center, 2),
                vec3.toMatrixString(camera.up, 2)])
                + ` near   = ${camera.near.toFixed(2).padStart(6, ' ')}`
                + `\n far    = ${camera.far.toFixed(2).padStart(6, ' ')}`
                + `\n fovy   = ${camera.fovy.toFixed(2).padStart(6, ' ')}`
                + `\n aspect = ${camera.aspect.toFixed(2).padStart(6, ' ')}`;

            let lookAtCGM;
            let lookAtGLM;
            {
                let n = vec3.subtract(vec3.create(), camera.eye, camera.center);
                vec3.normalize(n, n); // !
                let u = vec3.cross(vec3.create(), camera.up, n);
                vec3.normalize(u, u); // !
                let v = vec3.cross(vec3.create(), n, u);
                vec3.normalize(v, v); // !

                lookAtCGM = mat4.mul(mat4.create(),
                    mat4.transpose(mat4.create(), mat4.fromValues(
                        u[0], u[1], u[2], 0,
                        v[0], v[1], v[2], 0,
                        n[0], n[1], n[2], 0,
                        0, 0, 0, 1)),
                    mat4.transpose(mat4.create(), mat4.fromValues(
                        1, 0, 0, -camera.eye[0],
                        0, 1, 0, -camera.eye[1],
                        0, 0, 1, -camera.eye[2],
                        0, 0, 0, 1))
                );
                // let lookAtCGM = mat4.mul(mat4.create(),
                //     mat4.fromValues(
                //         1, 0, 0, -camera.eye[0],
                //         0, 1, 0, -camera.eye[1],
                //         0, 0, 1, -camera.eye[2],
                //         0, 0, 0, 1),
                //     mat4.fromValues(
                //         u[0], u[1], u[2], 0,
                //         v[0], v[1], v[2], 0,
                //         n[0], n[1], n[2], 0,
                //         0, 0, 0, 1),
                // );

                // mat4.transpose(lookAtCGM, lookAtCGM);
                lookAtGLM = camera.view; //mat4.lookAt...

                const preCameraView = document.getElementById('camera.view');
                preCameraView.innerHTML = math.interleaveMatrixStrings([
                    mat4.toMatrixString(lookAtGLM, 4),
                    mat4.toMatrixString(lookAtCGM, 4)
                ]);

            }
            {
                const theta_y = camera.fovy * math.DEG2RAD;
                const theta_x = camera.fovx * math.DEG2RAD;
                console.log(camera.fovx, camera.fovy);
                let P1 = mat4.fromValues(
                    1.0 / Math.tan(theta_x * 0.5), 0.0, 0.0, 0.0,
                    0.0, 1.0 / Math.tan(theta_y * 0.5), 0.0, 0.0,
                    0.0, 0.0, 1.0, 0.0,
                    0.0, 0.0, 0.0, 1.0
                );
                let f = camera.far;
                let P2 = mat4.fromValues(
                    1.0, 0.0, 0.0, 0.0,
                    // +1.0, 0.0, 0.0, 0.0, // gl-matrix
                    0.0, 1.0, 0.0, 0.0,
                    // 0.0, +1.0, 0.0, 0.0, // gl-matrix
                    0.0, 0.0, -1.0, 0.0,
                    // 0.0, 0.0, -1.0, 0.0, // gl-matrix
                    0.0, 0.0, 0.0, +1.0
                );
                let n = camera.near;
                let k = n / f; // ?
                let P3 = mat4.fromValues(
                    1.0, 0.0, 0.0, 0.0,
                    0.0, 1.0, 0.0, 0.0,
                    0.0, 0.0, 1.0 / (1.0 - k), -k / (1.0 - k),
                    // 0.0, 0.0, (f + n) / (n - f), 2.0 * f * n / (n - f), // gl-matrix
                    0.0, 0.0, -1.0, 0.0
                );


                mat4.transpose(P1, P1);
                mat4.transpose(P2, P2);
                mat4.transpose(P3, P3);

                let perspectiveCGM = mat4.create();
                perspectiveCGM = mat4.mul(mat4.create(), P2, P1);
                perspectiveCGM = mat4.mul(mat4.create(), P3, perspectiveCGM);

                // mat4.transpose(perspectiveCGM, perspectiveCGM);
                const perspectiveGLM = camera.projection; // mat4.perspective...

                const preCameraP123 = document.getElementById('camera.p123');
                preCameraP123.innerHTML = math.interleaveMatrixStrings([
                    mat4.toMatrixString(P1, 2),
                    mat4.toMatrixString(P2, 2),
                    mat4.toMatrixString(P3, 2)
                ]);

                const preCameraProjection = document.getElementById('camera.projection');
                preCameraProjection.innerHTML = math.interleaveMatrixStrings([
                    mat4.toMatrixString(perspectiveGLM, 4),
                    mat4.toMatrixString(perspectiveCGM, 4)
                ]);



                let v1 = math.vec4.fromValues(0.0, 0.0, 1.0); v1[3] = 1.0;
                math.vec4.log(v1);

                let TCGM = mat4.mul(mat4.create(), perspectiveCGM, lookAtCGM);
                let vtCGM = math.vec4.transformMat4(vec4.create(), v1, TCGM);

                math.vec4.scale(vtCGM, vtCGM, 1.0 / vtCGM[3]);

                let TGLM = mat4.mul(mat4.create(), perspectiveGLM, lookAtGLM);
                let vtGLM = math.vec4.transformMat4(vec4.create(), v1, TGLM);

                math.vec4.scale(vtGLM, vtGLM, 1.0 / vtGLM[3]);

                console.log(math.interleaveMatrixStrings([
                    mat4.toMatrixString(perspectiveGLM, 4),
                    vec4.toMatrixString(v1, 4),
                    vec4.toMatrixString(vtGLM, 4)
                ]));

                console.log(math.interleaveMatrixStrings([
                    mat4.toMatrixString(perspectiveCGM, 4),
                    vec4.toMatrixString(v1, 4),
                    vec4.toMatrixString(vtCGM, 4)
                ]));


                let A = mat4.fromValues(
                    1, 2, 3, 4,
                    5, 6, 7, 8,
                    9, 10, 11, 12,
                    13, 14, 15, 16);

                let B = mat4.fromValues(
                    17, 18, 19, 20,
                    21, 22, 23, 24,
                    25, 26, 27, 28,
                    29, 30, 31, 32);

                let C = mat4.mul(mat4.create(), A, B);
                console.log(math.interleaveMatrixStrings([
                    mat4.toMatrixString(C, 4),
                    mat4.toMatrixString(A, 4),
                    mat4.toMatrixString(B, 4)
                ]));
            }

        }

        {   // formatted output test

            // console.log();
            // console.log('Random vec2, vec3, and vec4:');
            // console.log(math.interleaveMatrixStrings([
            //     math.vec2.toMatrixString(math.vec2.random(), 12),
            //     math.vec3.toMatrixString(math.vec3.random(-1.0, +1.0), 10),
            //     math.vec4.toMatrixString(math.vec4.random(-100.0, +100.0), 8)]));

            // console.log('Random mat2, mat3, and mat4:');
            // console.log(math.interleaveMatrixStrings([
            //     math.mat2.toMatrixString(math.mat2.random(), 6),
            //     math.mat3.toMatrixString(math.mat3.random(-1.0, +1.0), 4),
            //     math.mat4.toMatrixString(math.mat4.random(-100.0, +100.0), 2)]));

            // console.log('Random mat8x4 (2 digits):');
            // math.logArrayAsMatrix(Float32Array.from({ length: 8 * 4 }, () => Math.random()), 8, 2);

            // console.log('Random mat8x16 (4 digits):');
            // math.logArrayAsMatrix(Float32Array.from({ length: 8 * 16 }, () => Math.random() * 2.0 - 1.0), 8, 4);
        }

    };
</script>

<style>
    body {
        font-weight: 300;
        font-family: "Roboto";
    }

    strong {
        font-weight: 700;
    }

    code {
        font-weight: 300 !important;
        font-size: 1em;
        font-family: "Roboto Mono" !important;
    }
</style>

</html>
