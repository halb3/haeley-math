<!doctype html>
<html lang="en">


<head>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-widthinitial-scale=1">
    <title>undefined</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/roboto@4.5.1/latin-300.css"
        integrity="sha256-69VEtqsA54dXolmlOOpB6AUTkUBjI8SjBKCQ7ycib6I=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/roboto@4.5.1/latin-700.css"
        integrity="sha256-tB5d+zyWiHQFQmJbLkUB/R3yq3K5zmN+38cBOZBwjkg=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/roboto-mono@4.5.0/latin-300.css"
        integrity="sha256-/bTf0ZdBXp9eQn0Xbgim3IoygJpVg108KstIe5AKO7E=" crossorigin="anonymous">
</head>

<body>

    <section class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <h1>haeley-<strong>math</strong></h1>
                <p class="lead">Test Page for Development</p>
                <p>// about:
                    version <code id="version">version</code>,
                    branch <code id="branch">branch</code>,
                    commit <code id="commit">commit</code>.
                </p>

            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <h2>Float32Array to Matrix String</h2>
                <p>Float32Array to columnar-string (matrix) with fixed digits:</p>

                <form class="row">
                    <div class="col-2 text-end">
                        <label for="range-columns" class="form-label form-control-sm"># columns:</label>
                    </div>
                    <div class="col">
                        <input type="range" class="form-range form-control-sm" id="range-columns" step="1" min="1"
                            max="16" value="4">
                    </div>
                    <div class="col-2">
                        <input id="number-columns" type="number" class="form-control form-control-sm" placeholder="1"
                            step="1" min="0" max="8" value="4">
                    </div>
                </form>
                <form class="row">
                    <div class="col-2 text-end">
                        <label for="range-digits" class="form-label form-control-sm"># digits:</label>
                    </div>
                    <div class="col">
                        <input type="range" class="form-range form-control-sm" id="range-digits" step="1" min="0"
                            max="8" value="2">
                    </div>
                    <div class="col-2">
                        <input id="number-digits" type="number" class="form-control form-control-sm" placeholder="1"
                            step="1" min="0" max="8" value="2">
                    </div>
                </form>
                <pre class="bg-light px-3 py-2 border-start" id="columns-and-digits"></pre>

                <p>Some more examples:</p>

                <pre class="bg-light px-3 py-2 border-start text-black" id="matrix-examples"></pre>

            </div>
        </div>



        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <h2>Camera (Perspective):</h2>
                <p>Parse vec3 from string for eye, center, and up:</p>

                <div class="row g-2 mb-2">
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control font-monospace" id="text-eye" value="0.0, 0.0, 2.0">
                            <label
                                for="text-eye"><code>camera.eye = <span class="text-muted">x,y,z</span></code></label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control font-monospace" id="text-center"
                                value="0.0, 0.0, 0.0">
                            <label
                                for="text-center"><code>camera.center = <span class="text-muted">x,y,z</span></code></label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control font-monospace" id="text-up" value="0.0, 1.0, 0.0">
                            <label for="text-up"><code>camera.up = <span class="text-muted">x,y,z</span></code></label>
                        </div>
                    </div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col">
                        <div class="form-floating">
                            <input type="number" class="form-control font-monospace" id="number-near" value="0.01">
                            <label for="number-near"><code>camera.near</code></label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="number" class="form-control font-monospace" id="number-far" value="8.00">
                            <label for="number-far"><code>camera.far</code></label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="number" class="form-control font-monospace" id="number-fovy" value="45.00">
                            <label for="number-fovy"><code>camera.fovy</code></label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="number" class="form-control font-monospace" id="number-aspect" value="1.7778">
                            <label for="number-aspect"><code>camera.aspect</code></label>
                        </div>
                    </div>
                </div>

                <p class="mb-1">camera <code>eye</code>, <code>center</code>, and <code>up</code> as well as
                    <code>near</code>, <code>far</code>, <code>fovy</code>, and <code>aspect</code>:
                </p>
                <pre class="bg-light px-3 py-2 border-start" id="parsed-camera"></pre>
                <!--
                <p>Compare virtual camera math (gl-matrix) with math based on <a
                        href="https://cgmath.cc/units/virtual-camera.html">cgmath.cc</a>.</p>

                <p class="mb-1">camera.view (gl-matrix mat4.lookAt) left vs. cgmath lookAt (transposed) right:</p>
                <pre class="bg-light px-3 py-2 border-start" id="camera.view"></pre>

                <p class="mb-1">camera.projection (gl-matrix mat4.perspective) left vs. cgmath projection (transposed)
                    right:</p>
                <pre class="bg-light px-3 py-2 border-start" id="camera.projection"></pre>

                <p class="mb-1">cgmath projection sub-transforms (PI, PII, PIII):</p>
                <pre class="bg-light px-3 py-2 border-start" id="camera.p123"></pre>

                <p class="mb-1">cgmath projection sub-transforms (PI, PII, PIII):</p>
                <pre class="bg-light px-3 py-2 border-start" id="camera.p123"></pre> -->

            </div>
        </div>


    </section>

    <footer>
        <div class="row text-center">
            <div class="col-12">
                <p class="mt-5 mb-4">
                    &copy; 2016&thinsp;&ndash;&thinsp;<span id="cryear"></span>
                </p>
            </div>
        </div>
    </footer>

</body>

<script type="module">
    import * as auxiliaries from 'haeley-auxiliaries';
    import * as math from './index.ts';
    window['haeley'] = { auxiliaries, math };
</script>

<script>

    window.onload = () => {

        const math = haeley.math;

        document.title = __LIB_NAME__;
        document.querySelector('#version').innerHTML = math.version();
        document.querySelector('#branch').innerHTML = math.branch();
        document.querySelector('#commit').innerHTML = math.commit();
        document.querySelector('#cryear').innerHTML = new Date().getFullYear();

        console.log("'haeley-math' imported:", haeley);


        {   // interactive array to matrix test

            const preColumnsDigits = document.getElementById('columns-and-digits');
            const test = math.mat4.random(-16.0, +16.0);

            const rangeColumns = document.getElementById('range-columns');
            const numberColumns = document.getElementById('number-columns');
            const rangeDigits = document.getElementById('range-digits');
            const numberDigits = document.getElementById('number-digits');

            const updateColumnsAndDigits = () => {
                const columns = parseInt(rangeColumns.value, 10);
                const digits = parseInt(rangeDigits.value, 10);
                preColumnsDigits.innerHTML =
                    `// haeley.math.matrixStringFromArray([...], ${columns}, ${digits}):\n`
                    + math.matrixStringFromArray(
                        test, parseInt(rangeColumns.value, 10), parseInt(rangeDigits.value, 10));
            };
            updateColumnsAndDigits();

            rangeColumns.oninput = (event) => {
                numberColumns.value = event.target.value;
                updateColumnsAndDigits();
            };
            numberColumns.onchange = (event) => {
                rangeColumns.value = event.target.value;
                updateColumnsAndDigits();
            };
            rangeDigits.oninput = (event) => {
                numberDigits.value = event.target.value;
                updateColumnsAndDigits();
            };
            numberDigits.onchange = (event) => {
                rangeDigits.value = event.target.value;
                updateColumnsAndDigits();
            };
        }


        {   // formatted output test

            const preMatrixExamples = document.getElementById('matrix-examples');

            preMatrixExamples.innerHTML = `// random vec2, vec3, and vec4:
${math.interleaveMatrixStrings([
                math.vec2.toMatrixString(math.vec2.random(), 12),
                math.vec3.toMatrixString(math.vec3.random(-1.0, +1.0), 10),
                math.vec4.toMatrixString(math.vec4.random(-100.0, +100.0), 8)])}
// random mat2, mat3, and mat4:
${math.interleaveMatrixStrings([
                    math.mat2.toMatrixString(math.mat2.random(), 6),
                    math.mat3.toMatrixString(math.mat3.random(-1.0, +1.0), 4),
                    math.mat4.toMatrixString(math.mat4.random(-100.0, +100.0), 2)])}
// random mat8x4 (2 digits):
${math.matrixStringFromArray(Float32Array.from({ length: 8 * 4 }, () => Math.random()), 8, 2)}
// random mat8x16 (4 digits):
${math.matrixStringFromArray(Float32Array.from({ length: 8 * 16 }, () => Math.random() * 2.0 - 1.0), 8, 4)}`;
        }


        {   // virtual camera math test

            const vec3 = math.vec3;
            const vec4 = math.vec4;
            const mat4 = math.mat4;

            const camera = new math.Camera();
            camera.eye = [0.0, 0.0, 0.0]; // [2.0, 0.5, -4.0];
            camera.center = [0.0, 0.0, 1.0]; // [0.0, -0.5, 2.0];
            camera.up = [0.0, 1.0, 0.0]; //[0.0, 2.0, 0.0];
            camera.near = 0.5;
            camera.far = 1.0;
            camera.aspect = 16.0 / 9.0;

            window['camera'] = camera;

            const preCamera = document.getElementById('parsed-camera');
            const textCameraEye = document.getElementById('text-eye');
            const textCameraCenter = document.getElementById('text-center');
            const textCameraUp = document.getElementById('text-up');

            const numberCameraNear = document.getElementById('number-near');
            const numberCameraFar = document.getElementById('number-far');
            const numberCameraFovy = document.getElementById('number-fovy');
            const numberCameraAspect = document.getElementById('number-aspect');

            const invalidate = (element, valid) => {
                element.classList.remove(valid ? 'is-invalid' : 'is-valid');
                element.classList.add(valid ? 'is-valid' : 'is-invalid');
            }

            textCameraEye.onchange = () => { updateCameraTest(); };
            textCameraCenter.onchange = () => { updateCameraTest(); };
            textCameraUp.onchange = () => { updateCameraTest(); };

            numberCameraNear.onchange = () => { updateCameraTest(); };
            numberCameraFar.onchange = () => { updateCameraTest(); };
            numberCameraFovy.onchange = () => { updateCameraTest(); };
            numberCameraAspect.onchange = () => { updateCameraTest(); };

            const updateCameraTest = () => {

                try {
                    camera.eye = math.vec3.parse(textCameraEye.value);
                    invalidate(textCameraEye, true);
                } catch { invalidate(textCameraEye, false); }
                try {
                    camera.center = math.vec3.parse(textCameraCenter.value);
                    invalidate(textCameraCenter, true);
                } catch { invalidate(textCameraCenter, false); }
                try {
                    camera.up = math.vec3.parse(textCameraUp.value);
                    invalidate(textCameraUp, true);
                } catch { invalidate(textCameraUp, false); }
                try {
                    camera.near = parseFloat(numberCameraNear.value, 10);
                    invalidate(numberCameraNear, true);
                } catch { invalidate(numberCameraNear, false); }
                try {
                    camera.far = parseFloat(numberCameraFar.value, 10);
                    invalidate(numberCameraFar, true);
                } catch { invalidate(numberCameraFar, false); }
                try {
                    camera.fovy = parseFloat(numberCameraFovy.value, 10);
                    invalidate(numberCameraFovy, true);
                } catch { invalidate(numberCameraFovy, false); }
                try {
                    camera.aspect = parseFloat(numberCameraAspect.value, 10);
                    invalidate(numberCameraAspect, true);
                } catch { invalidate(numberCameraAspect, false); }


                let lookAtCGM, lookAtGLM, perspectiveCGM, perspectiveGLM, P1, P2, P3;

                {
                    let n = vec3.subtract(vec3.create(), camera.center, camera.eye);
                    vec3.normalize(n, n); // !
                    let u = vec3.cross(vec3.create(), n, camera.up);
                    vec3.normalize(u, u); // !
                    let v = vec3.cross(vec3.create(), u, n);
                    vec3.normalize(v, v); // !

                    lookAtCGM = mat4.mul(mat4.create(),
                        mat4.transpose(mat4.create(), mat4.fromValues(
                            u[0], u[1], u[2], 0,
                            v[0], v[1], v[2], 0,
                            n[0], n[1], n[2], 0,
                            0, 0, 0, 1)),
                        mat4.transpose(mat4.create(), mat4.fromValues(
                            1, 0, 0, -camera.eye[0],
                            0, 1, 0, -camera.eye[1],
                            0, 0, 1, -camera.eye[2],
                            0, 0, 0, 1)),
                        mat4.fromValues(
                            1, 0, 0, 0,
                            0, 1, 0, 0,
                            0, 0, 1, 0,
                            0, 0, 0, 1)
                    );

                    lookAtGLM = camera.view
                }

                {
                    const theta_y = camera.fovy * math.DEG2RAD;
                    const theta_x = camera.fovx * math.DEG2RAD;

                    P1 = mat4.fromValues(
                        1.0 / Math.tan(theta_x * 0.5), 0.0, 0.0, 0.0,
                        0.0, 1.0 / Math.tan(theta_y * 0.5), 0.0, 0.0,
                        0.0, 0.0, 1.0, 0.0,
                        0.0, 0.0, 0.0, 1.0
                    );
                    let f = camera.far;
                    P2 = mat4.fromValues(
                        1.0 / f, 0.0, 0.0, 0.0,
                        0.0, 1.0 / f, 0.0, 0.0,
                        0.0, 0.0, 1.0 / f, 0.0,
                        0.0, 0.0, 0.0, +1.0
                    );
                    let n = camera.near;
                    let k = n / f; // ?
                    P3 = mat4.fromValues(
                        1.0, 0.0, 0.0, 0.0,
                        0.0, 1.0, 0.0, 0.0,
                        0.0, 0.0, 1.0 / (1.0 - k), -k / (1.0 - k),
                        0.0, 0.0, 1.0, 0.0
                    );

                    mat4.transpose(P1, P1);
                    mat4.transpose(P2, P2);
                    mat4.transpose(P3, P3);

                    perspectiveCGM = mat4.mul(mat4.create(), P2, P1);
                    perspectiveCGM = mat4.mul(perspectiveCGM, P3, perspectiveCGM);

                    perspectiveGLM = mat4.clone(camera.projection); // mat4.perspective...
                }

                preCamera.innerHTML = `${math.interleaveMatrixStrings([
                    vec3.toMatrixString(camera.eye, 2),
                    vec3.toMatrixString(camera.center, 2),
                    vec3.toMatrixString(camera.up, 2),
                    ` \n  near = ${camera.near.toFixed(2)}`
                    + `, far = ${camera.far.toFixed(2)},`
                    + `\n  fovy = ${camera.fovy.toFixed(2)}°,`
                    + `\n  aspect = ${camera.aspect.toFixed(2)} // width / height`
                ])}`;

                preCamera.innerHTML += '\n// view transform: lookAt (glm left, cgmath right)';
                preCamera.innerHTML += '\n' + math.interleaveMatrixStrings([
                    mat4.toMatrixString(lookAtGLM, 4),
                    mat4.toMatrixString(lookAtCGM, 4)]);

                preCamera.innerHTML += '\n// P1, P2, P3 (cgmath.cc):';
                preCamera.innerHTML += '\n' + math.interleaveMatrixStrings([
                    mat4.toMatrixString(P1, 2),
                    mat4.toMatrixString(P2, 2),
                    mat4.toMatrixString(P3, 2)]);

                preCamera.innerHTML += '\n// projection transform: perspective (glm left, cgmath right)';
                preCamera.innerHTML += '\n' + math.interleaveMatrixStrings([
                    mat4.toMatrixString(perspectiveGLM, 4),
                    mat4.toMatrixString(perspectiveCGM, 4)]);

                preCamera.innerHTML += '\n// view-projection transform: (glm left, cgmath right)';
                preCamera.innerHTML += '\n' + math.interleaveMatrixStrings([
                    mat4.toMatrixString(mat4.mul(mat4.create(), perspectiveGLM, lookAtGLM), 4),
                    mat4.toMatrixString(mat4.mul(mat4.create(), perspectiveCGM, lookAtCGM), 4)]);

            };
            updateCameraTest();
        }


    };
</script>

<style>
    body {
        font-weight: 300;
        font-family: "Roboto";
    }

    strong {
        font-weight: 700;
    }

    code {
        font-weight: 300 !important;
        font-size: 1em;
        font-family: "Roboto Mono" !important;
    }
</style>

</html>
